<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Entity Model · IxiaS</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Documentation for IxiaS'/>
<link rel="canonical" href="https://nextbeat-dev.github.io/ixias/01-Entity-Model.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/warnOldVersion.js"></script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>

<!--
<link rel="shortcut icon" href="images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>IxiaS
</a>
<div class="version-number">
2.1.1
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="01-Entity-Model.html" class="active page">Entity Model</a></li>
  <li><a href="02-Enum.html" class="page">Enum</a></li>
  <li><a href="03-Slick.html" class="page">Slick</a></li>
  <li><a href="04-Play-Framework.html" class="page">Play Framework</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="index.html">IxiaS</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>IxiaS
</a>
<div class="version-number">
2.1.1
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="01-Entity-Model.html" class="active page">Entity Model</a></li>
  <li><a href="02-Enum.html" class="page">Enum</a></li>
  <li><a href="03-Slick.html" class="page">Slick</a></li>
  <li><a href="04-Play-Framework.html" class="page">Play Framework</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="index.html">IxiaS</a></li>
  <li>Entity Model</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#entity-model" name="entity-model" class="anchor"><span class="anchor-link"></span></a>Entity Model</h1>
<p>以降のコード例では、以下のimportを想定しています。</p>
<pre class="prettyprint"><code class="language-scala">import ixias.model._
</code></pre>
<p>まず、IxiaSのEntity ModelはIdを持ちます。Idはコンパニオンオブジェクト内に定義を行い、Idの型と値を定義する必要があります。 Idは同一性を持つ識別子の役割を持っています。</p>
<pre class="prettyprint"><code class="language-scala">object User {
  val  Id = the[Identity[Id]]
  type Id = Long @@ User
}
</code></pre>
<p>Idの型は<code>shapeless.tag.@@</code>を用いて定義します。 <code>@@</code>は<code>shapeless.tag.@@</code>の型エイリアスです。</p>
<pre class="prettyprint"><code class="language-scala">type @@[+T, U] = shapeless.tag.@@[T, U]
</code></pre>
<p>こちらはTagged Typeと呼ばれる手法によって、Long型の値を扱うIdという異なる名前の型を持たせています。IdはLong型またはString型を選択することができます。</p>
<p>EntityModelクラスには、id、updatedAt、createdAtの3つの値を定義します。これらはEntityModelトレイトに抽象な値として定義されており、命名と型を定められた通りに定義する必要があります。</p>
<pre class="prettyprint"><code class="language-scala">case class User(
  id:        Option[User.Id],
  updatedAt: LocalDateTime,
  createdAt: LocalDateTime
) extends EntityModel[User.Id]
</code></pre>
<p>idの値は、Option[Id]型を持ちます。Option型にすることでIdがあるかないかを判別できます。</p>
<p>インスタンスの生成は、以下のように行います。</p>
<pre class="prettyprint"><code class="language-scala">val user: User#WithNoId = User(
  id        = None,
  updatedAt = LocalDateTime.now(),
  createdAt = LocalDateTime.now()
).toWithNoId
</code></pre>
<h2><a href="#withnoidとembeddedidの型の定義" name="withnoidとembeddedidの型の定義" class="anchor"><span class="anchor-link"></span></a>WithNoIdとEmbeddedIdの型の定義</h2>
<p>EntityModelトレイト内には先ほど<code>User#WithNoId</code>として登場したWithNoId型と共に、WithNoId型と対になる関係を持つEmbeddedId型が定義されています。2つの型は以下のような実装になります。</p>
<pre class="prettyprint"><code class="language-scala">type WithNoId = Entity.WithNoId [Id, this.type]
type EmbeddedId = Entity.EmbeddedId[Id, this.type]
</code></pre>
<p>これらは文脈を持つ型のような役割を持ち、WithNoIdはidを持たないEntity、EmbeddedIdはidを持つEntityという意味を持った型になります。</p>
<p>ここで呼び出しているEntity.WithNoIdとEntity.EmbeddedIdの型は以下のような実装になります。</p>
<pre class="prettyprint"><code class="language-scala">type WithNoId [K &lt;: @@[_, _], M &lt;: EntityModel[K]] =
  Entity[K, M, IdStatus.Empty]
type EmbeddedId[K &lt;: @@[_, _], M &lt;: EntityModel[K]] =
  Entity[K, M, IdStatus.Exists]
</code></pre>
<p>いずれも、1つ目の型パラメータKにはコンパニオンオブジェクト内で定義したIdを、2つ目の型パラメータMにはEntityModelクラスを受け取ります。</p>
<p>呼び出し元であるEntityModelトレイト内では、コンパニオンオブジェクト内で定義したIdとEntityModelトレイトを継承しているthis.typeを与えることで型パラメータの制約を満たしています。</p>
<p>そしてEntity.WithNoIdとEntity.EmbeddedIdでは、受け取った型であるKとMを用いてEntityクラスを呼び出しています。</p>
<p>ここで注目すべきは、Entityクラスが受け取る3つ目の型パラメータです。WithNoIdとEmbeddedIdの型の定義において3つ目の型パラメータに与えているIdStatusオブジェクトは以下のような実装になります。</p>
<pre class="prettyprint"><code class="language-scala">trait IdStatus
object IdStatus {
  trait Empty extends IdStatus
  trait Exists extends IdStatus
}
</code></pre>
<p>このIdStatusオブジェクト内に定義されているEmptyとExistsを用いて、WithNoIdとEmbeddedIdの判別を行います。</p>
<p><strong>WithNoIdとEmbeddedIdの値の生成</strong></p>
<p>次に、WithNoIdとEmbeddedIdの型を持つ値を生成するtoWithNoIdメソッドとtoEmbeddedIdメソッドについて説明します。2つのメソッドは以下のような実装になります。</p>
<pre class="prettyprint"><code class="language-scala">def toWithNoId: WithNoId = Entity.WithNoId(this)
def toEmbeddedId: EmbeddedId = Entity.EmbeddedId(this)
</code></pre>
<p>それぞれ、自身のインスタンスであるthisを引数としてEntityクラス内のオブジェクトを呼び出しています。</p>
<p>toWithNoIdメソッドを例に挙げると、toWithNoIdメソッドが呼び出しているEntity.WithNoIdオブジェクトの実装は以下のようになっています。</p>
<pre class="prettyprint"><code class="language-scala">object WithNoId {
  /** Create a entity object with no id. */
  def apply[K &lt;: @@[_, _], M &lt;: EntityModel[K]](data: M): WithNoId[K, M] =
    data.id match {
      case None =&gt; new Entity(data)
      case Some(_) =&gt;
        throw new IllegalArgumentException(“The entity’s ...”)
    }
}
</code></pre>
<p>与えられたEntityModelクラスのidをmatch式で判別することで、エラーハンドリングがされるような実装となっています。new User(…)内のidの値にOption型のNoneを与えているのはそのためです。</p>
<p>toWithNoIdメソッドに対してtoEmbeddedIdメソッドは、EmbeddedId型の値を生成します。しかし、IxiaSではEntity.EmbeddedId()を用いるユースケースはあまり多くありません。</p>
<p>理由としては、ixais.slickパッケージを組み合わせて永続ストレージとの連携を行う際、永続ストレージへのデータ取得リクエストによる返り値の型がEmbeddedIdにマッピングできるようになっているからです。</p>
<h2><a href="#entityクラスの実装" name="entityクラスの実装" class="anchor"><span class="anchor-link"></span></a>Entityクラスの実装</h2>
<p>Entityクラスにおいて<code>WithNoId</code>型と<code>EmbeddedId</code>型の違いを見ていきます。</p>
<p>まずはUserモデルの<code>WithNoId</code>型を生成して見ましょう。</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; val user: User#WithNoId = User(
  id        = None,
  updatedAt = LocalDateTime.now(),
  createdAt = LocalDateTime.now()
).toWithNoId

// val user: ixias.model.Entity[Long with shapeless.tag.Tagged[User],User,ixias.model.IdStatus.Empty] = Entity(User(None,2024-01-23T16:32:02.347987,2024-01-23T16:32:02.347994))
</code></pre>
<p>WithNoId型であるため、idの値がNoneになっていることが分かります。</p>
<p>この状態でidにアクセスを行なって見ましょう</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; user.id
// error: Cannot prove that ixias.model.IdStatus.Empty =:= ixias.model.IdStatus.Exists.
</code></pre>
<p>idの値が存在しないため、コンパイルエラーが発生します。 なぜコンパイルエラーとなるのか？それはEntityクラス内の<code>id</code>実装を見てみると分かります。</p>
<pre class="prettyprint"><code class="language-scala">/** get id value when id is exists */
def id(implicit ev: S =:= IdStatus.Exists): K = v.id.get
</code></pre>
<p>Entityクラス内に定義された<code>id</code>には<code>=:=</code>を用いた型制約が暗黙的に与えられており、型パラメータSにIdStatus.Existsが与えられているEmbeddedIdでないとidメソッドが提供されない仕様になっているためです。</p>
<p>そのため、型が<code>WithNoId</code>であるuserはidメソッドを呼ぶとエラーが起きます。</p>
<p>その他のプロパティに関しては<code>{model}.v.{property}</code>のようにv(value)に続けて入力することで、EntityModelクラス内の値を取得できます。(EmbeddedId型の場合も同様です。)</p>
<p>試しに<code>v</code>経由ではなく直説アクセスを行うとエラーが発生します。</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; user.updatedAt
            ^
       error: value updatedAt is not a member of ixias.model.Entity[Long with shapeless.tag.Tagged[User],User,ixias.model.IdStatus.Empty]
</code></pre>
<p><code>v</code>を経由することでアクセスすることができます。</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; user.v.updatedAt
val res3: java.time.LocalDateTime = 2024-01-23T16:32:02.347987
</code></pre>
<p>次に、Userモデルの<code>EmbeddedId</code>型を生成して見ましょう。</p>
<p>まずEntityクラスの識別子となるIdは以下のように生成します。</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; val userId = User.Id(1)
val userId: User.Id = 1
</code></pre>
<p>次に、<code>EmbeddedId</code>型を生成します。</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; val user: User#EmbeddedId = User(
     |   id = Some(userId),
     |   updatedAt = LocalDateTime.now(),
     |   createdAt = LocalDateTime.now()
     | ).toEmbeddedId
val user: ixias.model.Entity[Long with shapeless.tag.Tagged[User],User,ixias.model.IdStatus.Exists] = Entity(User(Some(1),2024-01-23T16:46:03.249446,2024-01-23T16:46:03.249462))
</code></pre>
<p>idの値がSome(userId)になっていることが分かります。</p>
<p>EmbeddedId型の場合はエラーが起きずにidを取得することができます。</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; user.id
val res0: Long with shapeless.tag.Tagged[User] = 1
</code></pre>
<p>EmbeddedIdはidを持っていることを保証する型であるため、Option型で返す必要がありません。</p>
<p>この制約によりコンパイル時にエラーとなり、障害を減らすことができるようです。</p>
<p>最初の方に記載した文脈を持つ型の説明に戻ります。</p>
<blockquote>
  <p>これらは文脈を持つ型のような役割を持ち、WithNoIdはidを持たないEntity、EmbeddedIdはidを持つEntityという意味を持った型になります。</p>
</blockquote>
<p>IxiaSを使用してモデルを定義する際、EntityModelトレイトを継承したクラスを定義することで、Idを持たないWithNoId型とIdを持つEmbeddedId型の2つの型を取り扱います。 NextbeatではIxiaSのEntityを使用したモデルは、DBのテーブルと1対1で対応するデータ型として使用しています。 また、NextbeatではDBのテーブルには識別子としてAuto Incrementの値を持つ<code>id</code>カラムを設定しています。</p>
<p>ここでいうIdを持たないWithNoId型とはDBにデータを格納する前(Auto Incrementによって採番される前)のレコードを表現して、Idを持つEmbeddedId型とはDBにデータを格納した後(Auto Incrementによって採番された後)のレコードを表現しています。</p>
<h2><a href="#entitymodelの更新" name="entitymodelの更新" class="anchor"><span class="anchor-link"></span></a>EntityModelの更新</h2>
<p>Entityにはmapメソッドが用意されており、Functionを適用した新たなEntityを返すことができます。実装は以下のようになっています。</p>
<pre class="prettyprint"><code class="language-scala">/** Builds a new `Entity` by applying a function to values. */
@inline def map[M2 &lt;: EntityModel[K]](f: M =&gt; M2): Entity[K, M2, S] = new Entity(f(v))
</code></pre>
<p>Entityの更新を行いたい場合は、mapメソッドを用いて以下のように実装します。</p>
<pre class="prettyprint"><code class="language-shell">scala&gt; val updatedUser: User#EmbeddedId = user.map(_.copy(id = Some(User.Id(2))))
val updatedUser: ixias.model.Entity[Long with shapeless.tag.Tagged[User],User,ixias.model.IdStatus.Exists] = Entity(User(Some(2),2024-01-23T16:46:03.249446,2024-01-23T16:46:03.249462))
</code></pre>
<h2><a href="#引用元" name="引用元" class="anchor"><span class="anchor-link"></span></a>引用元</h2>
<p><a href="https://medium.com/nextbeat-engineering/%E8%87%AA%E7%A4%BEoss-ixias-%E3%81%AE%E7%B4%B9%E4%BB%8B-ixais-model%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89-d6e0e5d8e8aa">自社OSS「IxiaS」の紹介 ~ ixais.modelパッケージのサンプルコード ~</a></p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/nextbeat-dev/ixias/tree/v2.1.1/docs/target/mdoc/01-Entity-Model.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="02-Enum.html">Enum</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="01-Entity-Model.html#entity-model" class="header">Entity Model</a>
  <ul>
    <li><a href="01-Entity-Model.html#withnoidとembeddedidの型の定義" class="header">WithNoIdとEmbeddedIdの型の定義</a></li>
    <li><a href="01-Entity-Model.html#entityクラスの実装" class="header">Entityクラスの実装</a></li>
    <li><a href="01-Entity-Model.html#entitymodelの更新" class="header">EntityModelの更新</a></li>
    <li><a href="01-Entity-Model.html#引用元" class="header">引用元</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2024</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '2.1.1', 'https://nextbeat-dev.github.io/ixias/')});</script>


</html>
